<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Wan!Voice</title>
<style>
:root{--a:#30D158;--bg:#000;--g:rgba(255,255,255,0.03);--gh:rgba(255,255,255,0.08);--b:rgba(255,255,255,0.08);--bl:rgba(255,255,255,0.12);--t1:rgba(255,255,255,0.95);--t2:rgba(255,255,255,0.70);--t3:rgba(255,255,255,0.45);--cg:#30D158;--ci:#FFD60A;--ct:#FF453A;--co:#BF5AF2;--ph:#FF453A;--pm:#FF9F0A;--pl:#30D158;--r:14px;--sb:env(safe-area-inset-bottom,0px)}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg);color:var(--t1);min-height:100dvh;line-height:1.5}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 20% 20%,rgba(48,209,88,0.08) 0%,transparent 50%);pointer-events:none;z-index:-1}
.app{display:flex;flex-direction:column;min-height:100dvh}
.hd{background:rgba(0,0,0,0.72);backdrop-filter:blur(40px);-webkit-backdrop-filter:blur(40px);border-bottom:0.5px solid var(--b);padding:12px 16px;position:sticky;top:0;z-index:100}
.hdc{display:flex;justify-content:space-between;align-items:center;max-width:1200px;margin:0 auto}
.hdb{display:flex;align-items:center;gap:10px}
.logo{width:40px;height:40px;background:linear-gradient(145deg,var(--a),#22B848);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:800;color:#fff}
.brt{font-size:16px;font-weight:700;color:var(--a)}
.brs{font-size:9px;color:var(--t3);letter-spacing:0.08em;text-transform:uppercase}
.hdr{display:flex;align-items:center;gap:8px}
.sp{display:flex;align-items:center;gap:6px;padding:6px 12px;background:var(--g);border:0.5px solid var(--b);border-radius:100px;font-size:9px;font-weight:600;color:var(--t2);text-transform:uppercase}
.sd{width:6px;height:6px;background:var(--a);border-radius:50%;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
.bi{width:38px;height:38px;background:var(--g);border:0.5px solid var(--b);border-radius:10px;color:var(--t2);cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
.bi:hover{background:var(--gh);color:var(--t1)}
.bi svg{width:16px;height:16px}
.bi input{position:absolute;width:0;height:0;opacity:0}
label.bi{cursor:pointer;position:relative}
.mn{flex:1;padding:20px 16px;padding-bottom:calc(130px + var(--sb));overflow-y:auto}
.mi{max-width:1200px;margin:0 auto}
.sh{margin-bottom:20px}
.stg{display:inline-flex;align-items:center;gap:6px;padding:5px 12px;background:rgba(48,209,88,0.15);border:0.5px solid rgba(48,209,88,0.4);border-radius:100px;font-size:9px;font-weight:700;color:var(--a);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:12px}
.stg::before{content:'';width:5px;height:5px;background:var(--a);border-radius:50%}
.stt{font-size:24px;font-weight:700;letter-spacing:-0.03em;margin-bottom:4px}
.std{font-size:13px;color:var(--t3)}
.sg{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:16px}
@media(min-width:640px){.sg{grid-template-columns:repeat(3,1fr)}}
@media(min-width:1024px){.sg{grid-template-columns:repeat(6,1fr)}}
.sc{background:var(--g);backdrop-filter:blur(40px);-webkit-backdrop-filter:blur(40px);border:0.5px solid var(--b);border-radius:20px;padding:14px}
.sc.al{background:linear-gradient(145deg,rgba(48,209,88,0.12),rgba(48,209,88,0.04));border-color:rgba(48,209,88,0.4);cursor:pointer}
.sch{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px}
.scl{font-size:10px;color:var(--t3)}
.sci{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px}
.scv{font-size:26px;font-weight:700}
.scs{font-size:10px;color:var(--t3);margin-top:3px}
.sc.al .scl,.sc.al .scv{color:var(--a)}
.ab{font-size:8px;font-weight:800;color:var(--a);text-transform:uppercase;letter-spacing:0.12em;margin-bottom:2px}
.cd{background:var(--g);backdrop-filter:blur(40px);-webkit-backdrop-filter:blur(40px);border:0.5px solid var(--b);border-radius:20px;padding:16px;margin-bottom:14px}
.cdh{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.cdt{font-size:13px;font-weight:600;display:flex;align-items:center;gap:6px}
.cg{display:grid;gap:14px;margin-bottom:16px}
@media(min-width:900px){.cg{grid-template-columns:1.3fr 0.7fr}}
.cl{display:flex;justify-content:flex-end;gap:12px;flex-wrap:wrap}
.cli{display:flex;align-items:center;gap:5px;font-size:10px;color:var(--t2)}
.cld{width:8px;height:8px;border-radius:2px}
.bcw{position:relative;padding-left:30px;margin-top:12px}
.bya{position:absolute;left:0;top:0;bottom:24px;width:26px;display:flex;flex-direction:column;justify-content:space-between;font-size:9px;color:var(--t3);text-align:right;padding-right:4px}
.bc{display:flex;align-items:flex-end;gap:6px;height:130px;border-bottom:0.5px solid var(--b);padding-bottom:4px}
.bg{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px}
.bs{width:100%;max-width:36px;display:flex;flex-direction:column-reverse;border-radius:4px 4px 0 0;overflow:hidden}
.bseg{width:100%}
.bl{font-size:9px;color:var(--t3)}
.pw{display:flex;align-items:center;justify-content:center;gap:20px;flex-wrap:wrap;padding:10px 0}
.pcc{position:relative;width:120px;height:120px}
.pc{width:100%;height:100%;border-radius:50%}
.pcn{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;background:rgba(28,28,30,0.9);width:70px;height:70px;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center}
.pcnv{font-size:20px;font-weight:700}
.pcnl{font-size:7px;color:var(--t3);text-transform:uppercase;letter-spacing:0.1em}
.plg{display:flex;flex-direction:column;gap:8px}
.pli{display:flex;align-items:center;gap:6px;font-size:11px}
.plc{width:10px;height:10px;border-radius:3px}
.plv{margin-left:auto;color:var(--t2)}
.prg{display:grid;gap:12px}
@media(min-width:768px){.prg{grid-template-columns:repeat(3,1fr)}}
.pri{background:var(--g);border-radius:var(--r);padding:12px;border:0.5px solid var(--b)}
.prh{display:flex;justify-content:space-between;margin-bottom:6px;font-size:12px}
.prt{height:5px;background:rgba(255,255,255,0.08);border-radius:3px;overflow:hidden}
.prf{height:100%;border-radius:3px}
.fb{background:var(--g);backdrop-filter:blur(40px);-webkit-backdrop-filter:blur(40px);border:0.5px solid var(--b);border-radius:20px;padding:12px;margin-bottom:14px}
.fl{display:flex;flex-wrap:wrap;gap:8px}
.sbx{flex:1;min-width:160px;position:relative}
.sbx svg{position:absolute;left:10px;top:50%;transform:translateY(-50%);width:14px;height:14px;color:var(--t3)}
.sbx input{width:100%;padding:10px 12px 10px 34px;background:rgba(0,0,0,0.3);border:0.5px solid var(--b);border-radius:var(--r);color:var(--t1);font-size:13px}
.sbx input::placeholder{color:var(--t3)}
.sbx input:focus{outline:none;border-color:var(--a)}
select{padding:10px 12px;background:rgba(0,0,0,0.3);border:0.5px solid var(--b);border-radius:var(--r);color:var(--t1);font-size:13px;min-width:100px}
select:focus{outline:none;border-color:var(--a)}
.di{background:var(--g);backdrop-filter:blur(40px);-webkit-backdrop-filter:blur(40px);border:0.5px solid var(--b);border-radius:16px;padding:14px;margin-bottom:10px}
.di.dup{border-color:rgba(255,214,10,0.4)}
.dih{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;margin-bottom:8px}
.tgs{display:flex;flex-wrap:wrap;gap:5px}
.tg{display:inline-flex;align-items:center;gap:3px;padding:3px 8px;border-radius:6px;font-size:10px;font-weight:600}
.dc{font-size:13px;line-height:1.6;margin-bottom:8px}
.dm{display:flex;flex-wrap:wrap;gap:12px;font-size:11px;color:var(--t3)}
.dm span{display:flex;align-items:center;gap:3px}
.del-btn{background:rgba(255,69,58,0.15);border:1px solid rgba(255,69,58,0.3);color:#FF453A;cursor:pointer;padding:6px 12px;border-radius:8px;font-size:12px;font-weight:600}
.del-btn:hover{background:rgba(255,69,58,0.25)}
.del-btn:active{transform:scale(0.95)}
.bn{position:fixed;bottom:14px;left:50%;transform:translateX(-50%);background:rgba(28,28,30,0.88);backdrop-filter:blur(50px);-webkit-backdrop-filter:blur(50px);border:0.5px solid rgba(255,255,255,0.1);border-radius:26px;display:flex;align-items:stretch;padding-bottom:var(--sb);z-index:100;box-shadow:0 10px 40px rgba(0,0,0,0.5)}
.ni{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;width:70px;padding:14px 10px;border-radius:22px;background:transparent;border:none;color:var(--t3);font-size:10px;font-weight:600;cursor:pointer;text-align:center}
.ni:hover{color:var(--t2)}
.ni.act{color:var(--t1);background:rgba(255,255,255,0.1)}
.ni svg{width:22px;height:22px;stroke-width:1.7}
.nc{display:flex;flex-direction:column;align-items:center;padding:0 6px 10px 6px;margin-top:-20px}
.nf{width:60px;height:60px;background:linear-gradient(145deg,#4ADE80,#22C55E,#16A34A);border:none;border-radius:18px;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 24px rgba(34,197,94,0.5);margin-bottom:4px;position:relative;overflow:hidden}
.nf::before{content:'';position:absolute;top:0;left:0;right:0;height:50%;background:linear-gradient(180deg,rgba(255,255,255,0.3),rgba(255,255,255,0.05));border-radius:18px 18px 40% 40%}
.nf:hover{transform:translateY(-2px) scale(1.03)}
.nf:active{transform:scale(0.95)}
.nf svg{width:28px;height:28px;stroke-width:2.5;position:relative;z-index:1}
.nls{padding:6px 16px;border-radius:12px;background:transparent;border:none;color:var(--t3);font-size:10px;font-weight:600;cursor:pointer}
.nls:hover{color:var(--t2)}
.nls.act{color:var(--t1);background:rgba(255,255,255,0.08)}
.mo{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);z-index:200;align-items:flex-end;justify-content:center}
.mo.sh{display:flex}
@media(min-width:768px){.mo{align-items:center}}
.md{background:rgba(28,28,30,0.9);backdrop-filter:blur(60px);-webkit-backdrop-filter:blur(60px);border:0.5px solid var(--bl);border-radius:26px 26px 0 0;padding:20px;padding-bottom:calc(20px + var(--sb));width:100%;max-width:480px;max-height:90vh;overflow-y:auto;animation:modalSlide 0.4s}
@media(min-width:768px){.md{border-radius:26px}}
@keyframes modalSlide{from{transform:translateY(100%);opacity:0}to{transform:translateY(0);opacity:1}}
.mh{width:32px;height:4px;background:rgba(255,255,255,0.2);border-radius:2px;margin:0 auto 16px}
@media(min-width:768px){.mh{display:none}}
.mdh{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
.mdt{font-size:18px;font-weight:700}
.cb{background:var(--g);border:0.5px solid var(--b);border-radius:var(--r);color:var(--t3);cursor:pointer;width:34px;height:34px;display:flex;align-items:center;justify-content:center}
.cb:hover{background:var(--gh);color:var(--t1)}
.cb svg{width:16px;height:16px}
.fg{margin-bottom:14px}
.fr{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.fla{display:block;font-size:12px;color:var(--t2);margin-bottom:5px}
.fi{width:100%;padding:11px 12px;background:rgba(0,0,0,0.3);border:0.5px solid var(--b);border-radius:var(--r);color:var(--t1);font-size:13px}
.fi:focus{outline:none;border-color:var(--a)}
textarea.fi{resize:vertical;min-height:90px;line-height:1.5}
.vw{position:relative}
.vw textarea{padding-right:48px}
.vb{position:absolute;right:8px;bottom:8px;width:36px;height:36px;padding:0;background:var(--g);border:0.5px solid var(--b);border-radius:10px;color:var(--t3);cursor:pointer;display:flex;align-items:center;justify-content:center}
.vb:hover{border-color:var(--a);color:var(--a)}
.vb.rec{background:rgba(255,69,58,0.2);border-color:var(--ct);color:var(--ct);animation:recPulse 1.2s infinite}
@keyframes recPulse{0%,100%{opacity:1}50%{opacity:0.5}}
.vb svg{width:16px;height:16px}
.vs{font-size:10px;color:var(--t3);margin-top:4px;min-height:14px}
.vs.rec{color:var(--ct)}
.mbs{display:flex;gap:10px;margin-top:18px}
.btn{flex:1;padding:13px;border-radius:var(--r);font-size:13px;font-weight:600;cursor:pointer;border:none}
.btn-s{background:var(--g);color:var(--t2);border:0.5px solid var(--b)}
.btn-s:hover{background:var(--gh);color:var(--t1)}
.btn-p{background:linear-gradient(145deg,var(--a),#22B848);color:#fff;box-shadow:0 4px 16px rgba(48,209,88,0.4)}
.dg{background:var(--g);border:0.5px solid var(--b);border-left:3px solid var(--ci);border-radius:16px;padding:14px;margin-bottom:12px}
.dgh{display:flex;align-items:center;gap:6px;margin-bottom:10px;font-size:11px;font-weight:600;color:var(--ci)}
.de{background:rgba(0,0,0,0.2);border-radius:10px;padding:10px;margin-bottom:8px}
.de:last-child{margin-bottom:0}
.de.sim{background:rgba(255,214,10,0.06);border:0.5px solid rgba(255,214,10,0.15)}
.dem{font-size:10px;color:var(--t3);margin-bottom:4px;display:flex;align-items:center;gap:8px}
.smb{background:var(--ci);color:#000;padding:2px 6px;border-radius:4px;font-weight:700;font-size:9px}
.dec{font-size:12px;line-height:1.5}
.em{text-align:center;padding:30px 16px;color:var(--t3)}
.em p{font-size:13px}
.hdn{display:none!important}
</style>
</head>
<body>
<div class="app">
<header class="hd">
<div class="hdc">
<div class="hdb"><div class="logo">W!</div><div><div class="brt">Wan!Voice</div><div class="brs">Feedback Dashboard</div></div></div>
<div class="hdr">
<div class="sp"><span class="sd"></span><span>LIVE</span></div>
<label class="bi" title="ã‚¤ãƒ³ãƒãƒ¼ãƒˆ"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg><input type="file" id="csvI" accept=".csv"></label>
<button class="bi" onclick="exportCSV()" title="ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></button>
</div>
</div>
</header>
<main class="mn"><div class="mi">
<div id="tabDash">
<div class="sh"><div class="stg">Dashboard</div><h1 class="stt">Let's speak up!</h1><p class="std">Your Wan!</p></div>
<div class="sg" id="statsGrid"></div>
<div class="cg">
<div class="cd"><div class="cdh"><div class="cdt">ğŸ“Š ä¼šã”ã¨ã®æ¨ç§»</div><div class="cl" id="legend"></div></div><div class="bcw"><div class="bya" id="yAxis"></div><div class="bc" id="barChart"></div></div></div>
<div class="cd"><div class="cdh"><div class="cdt">ğŸ“ˆ ã‚«ãƒ†ã‚´ãƒªåˆ†å¸ƒ</div></div><div class="pw" id="pieChart"></div></div>
</div>
<div class="cd"><div class="cdh"><div class="cdt">âš¡ å„ªå…ˆåº¦åˆ¥</div></div><div class="prg" id="prioChart"></div></div>
</div>
<div id="tabList" class="hdn">
<div class="sh"><div class="stg">Data List</div><h1 class="stt">ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ä¸€è¦§</h1><p class="std">æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°</p></div>
<div class="fb"><div class="fl">
<div class="sbx"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" id="searchInput" placeholder="æ¤œç´¢..." oninput="renderList()"></div>
<select id="filterSession" onchange="renderList()"></select>
<select id="filterCategory" onchange="renderList()"><option value="all">å…¨ã‚«ãƒ†ã‚´ãƒª</option><option value="è‰¯ã‹ã£ãŸç‚¹">è‰¯ã‹ã£ãŸç‚¹</option><option value="æ”¹å–„ç‚¹">æ”¹å–„ç‚¹</option><option value="ãƒˆãƒ©ãƒ–ãƒ«">ãƒˆãƒ©ãƒ–ãƒ«</option><option value="ãã®ä»–">ãã®ä»–</option></select>
</div></div>
<div id="dataList"></div>
</div>
<div id="tabAnalysis" class="hdn">
<div class="sh"><div class="stg">Analysis</div><h1 class="stt">ã‚ˆãã‚ã‚‹å£°ã®åˆ†æ</h1><p class="std">é¡ä¼¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è‡ªå‹•æ¤œå‡º</p></div>
<div id="dupAnalysis"></div>
</div>
</div></main>
<nav class="bn">
<button class="ni act" onclick="switchTab('Dash',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg><span>ãƒ€ãƒƒã‚·ãƒ¥<br>ãƒœãƒ¼ãƒ‰</span></button>
<div class="nc"><button class="nf" onclick="openModal()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button><button class="nls" onclick="switchTab('List',this)">ä¸€è¦§</button></div>
<button class="ni" onclick="switchTab('Analysis',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg><span>ã‚ˆãã‚ã‚‹<br>å£°</span></button>
</nav>
</div>
<div class="mo" id="modal">
<div class="md">
<div class="mh"></div>
<div class="mdh"><div class="mdt">æ–°è¦ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</div><button class="cb" onclick="closeModal()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
<div class="fr"><div class="fg"><label class="fla">æ—¥ä»˜</label><input type="date" class="fi" id="inputDate"></div><div class="fg"><label class="fla">å›</label><input type="text" class="fi" id="inputSession" placeholder="ç¬¬â—‹å›"></div></div>
<div class="fr"><div class="fg"><label class="fla">ã‚«ãƒ†ã‚´ãƒª</label><select class="fi" id="inputCategory"><option value="è‰¯ã‹ã£ãŸç‚¹">è‰¯ã‹ã£ãŸç‚¹</option><option value="æ”¹å–„ç‚¹">æ”¹å–„ç‚¹</option><option value="ãƒˆãƒ©ãƒ–ãƒ«">ãƒˆãƒ©ãƒ–ãƒ«</option><option value="ãã®ä»–">ãã®ä»–</option></select></div><div class="fg"><label class="fla">å„ªå…ˆåº¦</label><select class="fi" id="inputPriority"><option value="ä¸­">ä¸­</option><option value="é«˜">é«˜</option><option value="ä½">ä½</option></select></div></div>
<div class="fg"><label class="fla">ã‚¹ã‚¿ãƒƒãƒ•å</label><input type="text" class="fi" id="inputStaff" placeholder="åå‰"></div>
<div class="fg"><label class="fla">å†…å®¹</label><div class="vw"><textarea class="fi" id="inputContent" placeholder="ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å†…å®¹..." rows="3"></textarea><button type="button" class="vb" id="voiceBtn" onclick="toggleVoice()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg></button></div><div class="vs" id="voiceStatus"></div></div>
<div class="mbs"><button class="btn btn-s" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="btn btn-p" onclick="addEntry()">è¿½åŠ </button></div>
</div>
</div>
<script>
var catColors = {'è‰¯ã‹ã£ãŸç‚¹':'#30D158','æ”¹å–„ç‚¹':'#FFD60A','ãƒˆãƒ©ãƒ–ãƒ«':'#FF453A','ãã®ä»–':'#BF5AF2'};
var prioColors = {'é«˜':'#FF453A','ä¸­':'#FF9F0A','ä½':'#30D158'};
var catIcons = {'è‰¯ã‹ã£ãŸç‚¹':'ğŸ‘','æ”¹å–„ç‚¹':'âœï¸','ãƒˆãƒ©ãƒ–ãƒ«':'âš ï¸','ãã®ä»–':'ğŸ“„'};

var data = [{id:1,date:'2024-01-15',session:'ç¬¬1å›',category:'è‰¯ã‹ã£ãŸç‚¹',staff:'ç”°ä¸­',content:'ã‚µãƒ³ãƒ—ãƒ«',priority:'ä¸­'}];
var recognition = null;
var isRecording = false;
var audioStream = null;

function initVoice() {
 var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
 if (!SpeechRecognition) {
 var btn = document.getElementById('voiceBtn');
 if (btn) btn.style.display = 'none';
 return;
 }
 recognition = new SpeechRecognition();
 recognition.lang = 'ja-JP';
 recognition.continuous = false;
 recognition.interimResults = true;
 recognition.onresult = function(e) {
 var final = '';
 var interim = '';
 for (var i = 0; i < e.results.length; i++) {
 if (e.results[i].isFinal) {
 final += e.results[i][0].transcript;
 } else {
 interim += e.results[i][0].transcript;
 }
 }
 if (final) {
 document.getElementById('inputContent').value += final;
 }
 document.getElementById('voiceStatus').textContent = interim || (isRecording ? 'ğŸ¤ è©±ã—ã¦ãã ã•ã„...' : '');
 };
 recognition.onerror = function(e) {
 if (e.error === 'no-speech' && isRecording) {
 setTimeout(startRecognition, 300);
 } else if (e.error === 'not-allowed') {
 document.getElementById('voiceStatus').textContent = 'âš ï¸ ãƒã‚¤ã‚¯è¨±å¯ãŒå¿…è¦ã§ã™';
 stopVoice();
 }
 };
 recognition.onend = function() {
 if (isRecording) {
 setTimeout(startRecognition, 300);
 }
 };
}

function startRecognition() {
 if (!isRecording || !recognition) return;
 try { recognition.start(); } catch(e) {}
}

function toggleVoice() {
 if (!recognition) {
 alert('éŸ³å£°å…¥åŠ›ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“');
 return;
 }
 if (isRecording) {
 stopVoice();
 } else {
 navigator.mediaDevices.getUserMedia({audio: true}).then(function(stream) {
 audioStream = stream;
 isRecording = true;
 recognition.start();
 document.getElementById('voiceBtn').classList.add('rec');
 document.getElementById('voiceStatus').textContent = 'ğŸ”´ éŒ²éŸ³ä¸­...';
 document.getElementById('voiceStatus').classList.add('rec');
 }).catch(function() {
 document.getElementById('voiceStatus').textContent = 'âš ï¸ ãƒã‚¤ã‚¯è¨±å¯ãŒå¿…è¦ã§ã™';
 });
 }
}

function stopVoice() {
 isRecording = false;
 try { recognition.abort(); } catch(e) {}
 document.getElementById('voiceBtn').classList.remove('rec');
 document.getElementById('voiceStatus').textContent = '';
 document.getElementById('voiceStatus').classList.remove('rec');
}

// é¡ä¼¼åº¦
function calcSimilarity(a, b) {
 var s1 = a.toLowerCase().replace(/[ã€ã€‚ï¼ï¼Ÿ\s]/g, '');
 var s2 = b.toLowerCase().replace(/[ã€ã€‚ï¼ï¼Ÿ\s]/g, '');
 if (s1 === s2) return 1;
 if (s1.length < 3 || s2.length < 3) return 0;
 var g1 = new Set();
 var g2 = new Set();
 for (var i = 0; i <= s1.length - 2; i++) g1.add(s1.substring(i, i + 2));
 for (var i = 0; i <= s2.length - 2; i++) g2.add(s2.substring(i, i + 2));
 var intersection = 0;
 g1.forEach(function(x) { if (g2.has(x)) intersection++; });
 var union = g1.size + g2.size - intersection;
 return union > 0 ? intersection / union : 0;
}

function findDuplicates() {
 var dups = [];
 var checked = new Set();
 for (var i = 0; i < data.length; i++) {
 if (checked.has(data[i].id)) continue;
 var similar = [];
 for (var j = i + 1; j < data.length; j++) {
 if (checked.has(data[j].id)) continue;
 var sim = calcSimilarity(data[i].content, data[j].content);
 if (sim > 0.4) {
 similar.push({item: data[j], sim: sim});
 checked.add(data[j].id);
 }
 }
 if (similar.length) {
 dups.push({orig: data[i], sim: similar});
 checked.add(data[i].id);
 }
 }
 return dups;
}

function getDupIds() {
 var dups = findDuplicates();
 var ids = new Set();
 dups.forEach(function(g) {
 ids.add(g.orig.id);
 g.sim.forEach(function(x) { ids.add(x.item.id); });
 });
 return ids;
}

function getStats() {
 var cat = {}, prio = {}, sess = {};
 data.forEach(function(d) {
 cat[d.category] = (cat[d.category] || 0) + 1;
 prio[d.priority] = (prio[d.priority] || 0) + 1;
 sess[d.session] = sess[d.session] || {total: 0};
 sess[d.session].total++;
 sess[d.session][d.category] = (sess[d.session][d.category] || 0) + 1;
 });
 return {cat: cat, prio: prio, sess: sess};
}

function getSessions() {
 var sessions = [];
 data.forEach(function(d) {
 if (sessions.indexOf(d.session) === -1) sessions.push(d.session);
 });
 return sessions.sort();
}

// æç”»
function renderStats() {
 var stats = getStats();
 var sessions = getSessions();
 var dups = findDuplicates();
 var dupCount = dups.length;
 var dupTotal = getDupIds().size;
 
 var html = '<div class="sc"><div class="sch"><span class="scl">ç·ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</span><div class="sci" style="background:rgba(48,209,88,0.15);">ğŸ“Š</div></div><div class="scv">' + data.length + '</div><div class="scs">' + sessions.length + 'å›åˆ†</div></div>';
 
 Object.keys(catColors).forEach(function(c) {
 var n = stats.cat[c] || 0;
 html += '<div class="sc"><div class="sch"><span class="scl">' + c + '</span><div class="sci" style="background:' + catColors[c] + '18;">' + catIcons[c] + '</div></div><div class="scv">' + n + '</div></div>';
 });
 
 html += '<div class="sc al" onclick="goAnalysis()"><div class="sch"><div><div class="ab">ALERT</div><span class="scl">ã‚ˆãã‚ã‚‹å£°</span></div><div class="sci" style="background:rgba(48,209,88,0.18);">ğŸ”„</div></div><div class="scv">' + dupCount + '</div><div class="scs">' + dupTotal + 'ä»¶è©²å½“</div></div>';
 
 document.getElementById('statsGrid').innerHTML = html;
}

function renderBarChart() {
 var stats = getStats();
 var sessions = getSessions();
 
 var legendHtml = '';
 Object.keys(catColors).forEach(function(c) {
 legendHtml += '<div class="cli"><div class="cld" style="background:' + catColors[c] + '"></div>' + c + '</div>';
 });
 document.getElementById('legend').innerHTML = legendHtml;
 
 if (!sessions.length) {
 document.getElementById('barChart').innerHTML = '<div class="em"><p>ãƒ‡ãƒ¼ã‚¿ãªã—</p></div>';
 document.getElementById('yAxis').innerHTML = '';
 return;
 }
 
 var max = 0;
 sessions.forEach(function(s) {
 var t = stats.sess[s] ? stats.sess[s].total : 0;
 if (t > max) max = t;
 });
 
 document.getElementById('yAxis').innerHTML = '<span>' + max + '</span><span>' + Math.round(max/2) + '</span><span>0</span>';
 
 var html = '';
 sessions.forEach(function(s) {
 var sessData = stats.sess[s] || {total: 0};
 var total = sessData.total || 0;
 var height = max ? (total / max) * 110 : 0;
 html += '<div class="bg"><div class="bs" style="height:' + height + 'px;">';
 Object.keys(catColors).forEach(function(c) {
 var n = sessData[c] || 0;
 var segHeight = total ? (n / total) * height : 0;
 html += '<div class="bseg" style="height:' + segHeight + 'px;background:' + catColors[c] + ';"></div>';
 });
 html += '</div><div class="bl">' + s + '</div></div>';
 });
 document.getElementById('barChart').innerHTML = html;
}

function renderPieChart() {
 var stats = getStats();
 var total = data.length;
 
 if (!total) {
 document.getElementById('pieChart').innerHTML = '<div class="em"><p>ãƒ‡ãƒ¼ã‚¿ãªã—</p></div>';
 return;
 }
 
 var gradient = [];
 var current = 0;
 Object.keys(catColors).forEach(function(c) {
 var n = stats.cat[c] || 0;
 var pct = (n / total) * 100;
 gradient.push(catColors[c] + ' ' + current + '% ' + (current + pct) + '%');
 current += pct;
 });
 
 var legendHtml = '';
 Object.keys(catColors).forEach(function(c) {
 var n = stats.cat[c] || 0;
 var pct = Math.round((n / total) * 100);
 legendHtml += '<div class="pli"><div class="plc" style="background:' + catColors[c] + '"></div><span>' + c + '</span><span class="plv">' + pct + '%</span></div>';
 });
 
 document.getElementById('pieChart').innerHTML = '<div class="pcc"><div class="pc" style="background:conic-gradient(' + gradient.join(',') + ');"></div><div class="pcn"><div class="pcnv">' + total + '</div><div class="pcnl">TOTAL</div></div></div><div class="plg">' + legendHtml + '</div>';
}

function renderPrioChart() {
 var stats = getStats();
 var total = data.length;
 var html = '';
 ['é«˜', 'ä¸­', 'ä½'].forEach(function(p) {
 var n = stats.prio[p] || 0;
 var pct = total ? Math.round(n / total * 100) : 0;
 html += '<div class="pri"><div class="prh"><span>å„ªå…ˆåº¦: ' + p + '</span><span>' + n + 'ä»¶</span></div><div class="prt"><div class="prf" style="width:' + pct + '%;background:' + prioColors[p] + ';"></div></div></div>';
 });
 document.getElementById('prioChart').innerHTML = html;
}

function goAnalysis() {
 switchTab('Analysis', document.querySelectorAll('.ni')[1]);
}

function updateSessionFilter() {
 var sessions = getSessions();
 var select = document.getElementById('filterSession');
 select.innerHTML = '<option value="all">å…¨ã¦ã®å›</option>';
 sessions.forEach(function(s) {
 select.innerHTML += '<option value="' + s + '">' + s + '</option>';
 });
}

function getFiltered() {
 var query = document.getElementById('searchInput').value.toLowerCase();
 var session = document.getElementById('filterSession').value;
 var category = document.getElementById('filterCategory').value;
 return data.filter(function(d) {
 var matchQuery = d.content.toLowerCase().indexOf(query) !== -1 || d.staff.toLowerCase().indexOf(query) !== -1;
 var matchSession = session === 'all' || d.session === session;
 var matchCategory = category === 'all' || d.category === category;
 return matchQuery && matchSession && matchCategory;
 });
}

function renderList() {
 var filtered = getFiltered();
 var dupIds = getDupIds();
 
 if (!filtered.length) {
 document.getElementById('dataList').innerHTML = '<div class="cd"><div class="em"><p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div></div>';
 return;
 }
 
 var html = '';
 filtered.forEach(function(d) {
 var isDup = dupIds.has(d.id);
 html += '<div class="di ' + (isDup ? 'dup' : '') + '">';
 html += '<div class="dih">';
 html += '<div class="tgs">';
 html += '<span class="tg" style="background:' + catColors[d.category] + '18;color:' + catColors[d.category] + ';">' + catIcons[d.category] + ' ' + d.category + '</span>';
 html += '<span class="tg" style="background:' + prioColors[d.priority] + '18;color:' + prioColors[d.priority] + ';">' + d.priority + '</span>';
 html += '</div>';
 html += '<button class="del-btn" onclick="deleteEntry(' + d.id + ')">ğŸ—‘ï¸ å‰Šé™¤</button>';
 html += '</div>';
 html += '<div class="dc">' + d.content + '</div>';
 html += '<div class="dm"><span>ğŸ“… ' + d.date + '</span><span>ğŸ‘¤ ' + d.staff + '</span><span>ğŸ·ï¸ ' + d.session + '</span></div>';
 html += '</div>';
 });
 document.getElementById('dataList').innerHTML = html;
}

function renderDuplicates() {
 var dups = findDuplicates();
 
 if (!dups.length) {
 document.getElementById('dupAnalysis').innerHTML = '<div class="cd"><div class="em"><p>é‡è¤‡ã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</p></div></div>';
 return;
 }
 
 var html = '';
 dups.forEach(function(g, i) {
 html += '<div class="dg"><div class="dgh">ğŸ”„ é‡è¤‡ã‚°ãƒ«ãƒ¼ãƒ— ' + (i + 1) + 'ï¼ˆ' + (g.sim.length + 1) + 'ä»¶ï¼‰</div>';
 html += '<div class="de"><div class="dem">' + g.orig.session + ' / ' + g.orig.staff + '</div><div class="dec">' + g.orig.content + '</div></div>';
 g.sim.forEach(function(x) {
 html += '<div class="de sim"><div class="dem">' + x.item.session + ' / ' + x.item.staff + '<span class="smb">é¡ä¼¼' + Math.round(x.sim * 100) + '%</span></div><div class="dec">' + x.item.content + '</div></div>';
 });
 html += '</div>';
 });
 document.getElementById('dupAnalysis').innerHTML = html;
}

function switchTab(tab, btn) {
 document.querySelectorAll('.ni').forEach(function(n) { n.classList.remove('act'); });
 document.querySelectorAll('.nls').forEach(function(n) { n.classList.remove('act'); });
 btn.classList.add('act');
 document.getElementById('tabDash').classList.add('hdn');
 document.getElementById('tabList').classList.add('hdn');
 document.getElementById('tabAnalysis').classList.add('hdn');
 if (tab === 'Dash') document.getElementById('tabDash').classList.remove('hdn');
 else if (tab === 'List') { document.getElementById('tabList').classList.remove('hdn'); renderList(); }
 else if (tab === 'Analysis') { document.getElementById('tabAnalysis').classList.remove('hdn'); renderDuplicates(); }
}

function openModal() {
 document.getElementById('modal').classList.add('sh');
 document.getElementById('inputDate').value = new Date().toISOString().split('T')[0];
}

function closeModal() {
 stopVoice();
 document.getElementById('modal').classList.remove('sh');
 document.getElementById('voiceStatus').textContent = '';
}

function addEntry() {
 var date = document.getElementById('inputDate').value;
 var session = document.getElementById('inputSession').value;
 var category = document.getElementById('inputCategory').value;
 var priority = document.getElementById('inputPriority').value;
 var staff = document.getElementById('inputStaff').value;
 var content = document.getElementById('inputContent').value;
 
 if (!date || !session || !staff || !content) {
 alert('å…¨ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
 return;
 }
 
 data.push({
 id: Date.now(),
 date: date,
 session: session,
 category: category,
 priority: priority,
 staff: staff,
 content: content
 });
 
 closeModal();
 renderAll();
 document.getElementById('inputSession').value = '';
 document.getElementById('inputStaff').value = '';
 document.getElementById('inputContent').value = '';
}

function deleteEntry(id) {
 if (confirm('ã“ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
 data = data.filter(function(d) { return d.id !== id; });
 renderAll();
 }
}

function exportCSV() {
 var headers = ['date', 'session', 'category', 'staff', 'content', 'priority'];
 var csv = headers.join(',') + '\n';
 data.forEach(function(d) {
 csv += headers.map(function(h) { return '"' + d[h] + '"'; }).join(',') + '\n';
 });
 var blob = new Blob(['\ufeff' + csv], {type: 'text/csv;charset=utf-8;'});
 var a = document.createElement('a');
 a.href = URL.createObjectURL(blob);
 a.download = 'wanvoice_' + new Date().toISOString().split('T')[0] + '.csv';
 a.click();
}

function renderAll() {
 renderStats();
 renderBarChart();
 renderPieChart();
 renderPrioChart();
 updateSessionFilter();
 renderList();
 renderDuplicates();
}

// åˆæœŸåŒ–
initVoice();
renderAll();

document.getElementById('modal').addEventListener('click', function(e) {
 if (e.target === this) closeModal();
});

document.getElementById('csvI').addEventListener('change', function(e) {
 var file = e.target.files[0];
 if (!file) return;
 var reader = new FileReader();
 reader.onload = function(ev) {
 try {
 var text = ev.target.result;
 var lines = text.split('\n');
 var headers = lines[0].split(',').map(function(h) { return h.trim().replace(/"/g, ''); });
 var count = 0;
 for (var i = 1; i < lines.length; i++) {
 var line = lines[i].trim();
 if (!line) continue;
 var values = [];
 var current = '';
 var inQuote = false;
 for (var j = 0; j < line.length; j++) {
 var ch = line[j];
 if (ch === '"') inQuote = !inQuote;
 else if (ch === ',' && !inQuote) { values.push(current.trim()); current = ''; }
 else current += ch;
 }
 values.push(current.trim());
 data.push({
 id: Date.now() + i,
 date: values[headers.indexOf('date')] || values[0] || '',
 session: values[headers.indexOf('session')] || values[1] || '',
 category: values[headers.indexOf('category')] || values[2] || 'è‰¯ã‹ã£ãŸç‚¹',
 staff: values[headers.indexOf('staff')] || values[3] || '',
 content: values[headers.indexOf('content')] || values[4] || '',
 priority: values[headers.indexOf('priority')] || values[5] || 'ä¸­'
 });
 count++;
 }
 renderAll();
 alert(count + 'ä»¶ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
 } catch (err) {
 alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
 }
 e.target.value = '';
 };
 reader.readAsText(file);
});
</script>
</body>
</html>
