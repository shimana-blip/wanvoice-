<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Wan!Voice - Supabase</title>
<style>
:root{
  --a:#30D158;--bg:#000;--card:rgba(28,28,30,0.8);--glass:rgba(255,255,255,0.03);
  --b:rgba(255,255,255,0.08);--bl:rgba(255,255,255,0.15);
  --t1:#fff;--t2:rgba(255,255,255,0.7);--t3:rgba(255,255,255,0.4);
  --good:#30D158;--warn:#FFD60A;--bad:#FF453A;--other:#BF5AF2;--ai:#5E5CE6;
  --supa:#3ECF8E;
  --r:16px;--sb:env(safe-area-inset-bottom,0px)
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{font-family:-apple-system,BlinkMacSystemFont,'SF Pro','Hiragino Sans',sans-serif;background:var(--bg);color:var(--t1);min-height:100dvh;line-height:1.5}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(circle at 30% 10%,rgba(62,207,142,0.12),transparent 40%),radial-gradient(circle at 80% 80%,rgba(94,92,230,0.08),transparent 40%);pointer-events:none}

.hd{background:rgba(0,0,0,0.6);backdrop-filter:blur(40px) saturate(180%);-webkit-backdrop-filter:blur(40px) saturate(180%);border-bottom:0.5px solid var(--b);padding:12px 20px;position:sticky;top:0;z-index:100}
.hdc{display:flex;justify-content:space-between;align-items:center;max-width:1200px;margin:0 auto}
.hdb{display:flex;align-items:center;gap:12px}
.logo{width:44px;height:44px;background:linear-gradient(145deg,#4ADE80,#22C55E);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:800;color:#fff;box-shadow:0 4px 12px rgba(34,197,94,0.3)}
.brt{font-size:18px;font-weight:700;background:linear-gradient(90deg,#fff,#3ECF8E);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.brs{font-size:10px;color:var(--supa);letter-spacing:0.5px;display:flex;align-items:center;gap:4px}
.brs::before{content:'';width:6px;height:6px;background:var(--supa);border-radius:50%;animation:pulse 2s infinite}
.hdr{display:flex;gap:8px}
.hbtn{width:40px;height:40px;background:var(--glass);border:0.5px solid var(--b);border-radius:12px;color:var(--t2);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
.hbtn:hover{background:var(--bl);color:var(--t1);transform:scale(1.05)}
.hbtn svg{width:18px;height:18px}
.hbtn input{position:absolute;opacity:0;width:0;height:0}
label.hbtn{position:relative}

.mn{padding:20px;padding-bottom:calc(100px + var(--sb));max-width:1200px;margin:0 auto}

/* Setup Section */
.setup-section{background:linear-gradient(145deg,rgba(62,207,142,0.15),rgba(62,207,142,0.02));border:0.5px solid rgba(62,207,142,0.3);border-radius:24px;padding:24px;margin-bottom:20px}
.setup-header{display:flex;align-items:center;gap:12px;margin-bottom:20px}
.setup-icon{width:48px;height:48px;background:linear-gradient(135deg,#3ECF8E,#2DA572);border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:24px}
.setup-title{font-size:18px;font-weight:700}
.setup-desc{font-size:12px;color:var(--t3)}
.setup-form{display:flex;flex-direction:column;gap:14px}
.setup-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:600px){.setup-row{grid-template-columns:1fr}}
.setup-label{font-size:11px;color:var(--t2);margin-bottom:4px;display:block}
.setup-input{width:100%;padding:12px 14px;background:rgba(0,0,0,0.4);border:0.5px solid var(--b);border-radius:12px;color:var(--t1);font-size:13px;font-family:monospace}
.setup-input:focus{outline:none;border-color:var(--supa)}
.setup-input::placeholder{color:var(--t3)}
.setup-btns{display:flex;gap:10px;margin-top:8px}
.setup-btn{flex:1;padding:14px;border-radius:12px;font-size:14px;font-weight:600;cursor:pointer;border:none;transition:all 0.2s}
.setup-btn.primary{background:linear-gradient(145deg,#3ECF8E,#2DA572);color:#000}
.setup-btn.primary:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(62,207,142,0.4)}
.setup-btn.secondary{background:var(--glass);color:var(--t2);border:0.5px solid var(--b)}
.setup-status{padding:12px;border-radius:10px;font-size:12px;margin-top:12px;display:none}
.setup-status.success{display:block;background:rgba(62,207,142,0.15);color:var(--supa);border:0.5px solid rgba(62,207,142,0.3)}
.setup-status.error{display:block;background:rgba(255,69,58,0.15);color:var(--bad);border:0.5px solid rgba(255,69,58,0.3)}
.connected-badge{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;background:rgba(62,207,142,0.15);border:0.5px solid rgba(62,207,142,0.3);border-radius:20px;font-size:11px;color:var(--supa);font-weight:600}
.connected-badge::before{content:'';width:8px;height:8px;background:var(--supa);border-radius:50%;animation:pulse 2s infinite}

/* Stats */
.stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px}
@media(min-width:768px){.stats{grid-template-columns:repeat(6,1fr)}}
.stat{background:var(--card);backdrop-filter:blur(20px);border:0.5px solid var(--b);border-radius:20px;padding:16px;text-align:center;transition:transform 0.2s}
.stat:hover{transform:translateY(-2px)}
.stat-icon{font-size:20px;margin-bottom:6px}
.stat-val{font-size:28px;font-weight:700;letter-spacing:-1px}
.stat-label{font-size:10px;color:var(--t3);text-transform:uppercase;letter-spacing:0.5px}
.stat.good .stat-val{color:var(--good)}
.stat.warn .stat-val{color:var(--warn)}
.stat.bad .stat-val{color:var(--bad)}

/* Charts */
.charts{display:grid;gap:16px;margin-bottom:20px}
@media(min-width:900px){.charts{grid-template-columns:1.4fr 0.6fr}}
.card{background:var(--card);backdrop-filter:blur(20px);border:0.5px solid var(--b);border-radius:24px;padding:20px;transition:all 0.3s}
.card:hover{border-color:var(--bl)}
.card-header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;margin-bottom:16px}
.card-title{font-size:14px;font-weight:600;display:flex;align-items:center;gap:8px}
.card-title span{font-size:16px}

.bar-wrap{position:relative;padding-left:32px}
.bar-y{position:absolute;left:0;top:0;bottom:24px;width:28px;display:flex;flex-direction:column;justify-content:space-between;font-size:10px;color:var(--t3);text-align:right}
.bar-chart{display:flex;align-items:flex-end;gap:8px;height:140px;border-bottom:1px solid var(--b);padding-bottom:8px}
.bar-group{flex:1;display:flex;flex-direction:column;align-items:center;gap:6px}
.bar-stack{width:100%;max-width:40px;display:flex;flex-direction:column-reverse;border-radius:6px 6px 0 0;overflow:hidden}
.bar-seg{width:100%;transition:height 0.5s ease}
.bar-label{font-size:10px;color:var(--t3)}
.legend{display:flex;flex-wrap:wrap;gap:10px;justify-content:flex-end}
.legend-item{display:flex;align-items:center;gap:4px;font-size:10px;color:var(--t2);background:rgba(255,255,255,0.05);padding:4px 8px;border-radius:6px}
.legend-dot{width:8px;height:8px;border-radius:2px}

.pie-wrap{display:flex;align-items:center;justify-content:center;gap:24px;flex-wrap:wrap;padding:10px 0}
.pie-container{position:relative;width:130px;height:130px}
.pie{width:100%;height:100%;border-radius:50%;transition:transform 0.3s}
.pie:hover{transform:scale(1.05)}
.pie-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;background:var(--bg);width:75px;height:75px;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center}
.pie-val{font-size:24px;font-weight:700}
.pie-label{font-size:8px;color:var(--t3);text-transform:uppercase;letter-spacing:1px}
.pie-legend{display:flex;flex-direction:column;gap:10px}
.pie-item{display:flex;align-items:center;gap:8px;font-size:12px}
.pie-dot{width:12px;height:12px;border-radius:4px}
.pie-pct{margin-left:auto;color:var(--t2);font-weight:600}

.prio-grid{display:grid;gap:12px}
@media(min-width:600px){.prio-grid{grid-template-columns:repeat(3,1fr)}}
.prio-item{background:var(--glass);border-radius:12px;padding:14px}
.prio-header{display:flex;justify-content:space-between;margin-bottom:8px;font-size:13px}
.prio-bar{height:6px;background:rgba(255,255,255,0.1);border-radius:3px;overflow:hidden}
.prio-fill{height:100%;border-radius:3px;transition:width 0.5s ease}

/* AI Chat */
.ai-section{background:linear-gradient(145deg,rgba(94,92,230,0.1),rgba(94,92,230,0.02));border:0.5px solid rgba(94,92,230,0.3);border-radius:24px;padding:20px;margin-bottom:20px}
.ai-header{display:flex;align-items:center;gap:12px;margin-bottom:16px}
.ai-avatar{width:52px;height:52px;border-radius:16px;display:flex;align-items:center;justify-content:center;overflow:hidden;box-shadow:0 4px 20px rgba(94,92,230,0.4)}
.ai-avatar svg{width:100%;height:100%}
.ai-info h3{font-size:15px;font-weight:600}
.ai-info p{font-size:11px;color:var(--t3)}
.ai-status{margin-left:auto;display:flex;align-items:center;gap:6px;font-size:11px;color:var(--good)}
.ai-status::before{content:'';width:8px;height:8px;background:var(--good);border-radius:50%;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.5;transform:scale(0.9)}}

.quick-btns{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px}
.qbtn{padding:10px 16px;background:rgba(94,92,230,0.15);border:0.5px solid rgba(94,92,230,0.3);border-radius:20px;color:#A5A4FB;font-size:12px;font-weight:500;cursor:pointer;transition:all 0.2s}
.qbtn:hover{background:rgba(94,92,230,0.25);transform:translateY(-1px)}

.chat-box{max-height:250px;overflow-y:auto;margin-bottom:14px;display:flex;flex-direction:column;gap:10px;scroll-behavior:smooth}
.msg{max-width:85%;padding:12px 16px;border-radius:20px;font-size:14px;line-height:1.6;animation:msgIn 0.3s ease}
@keyframes msgIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.msg.bot{background:linear-gradient(135deg,rgba(94,92,230,0.2),rgba(191,90,242,0.1));border:0.5px solid rgba(94,92,230,0.2);align-self:flex-start;border-bottom-left-radius:6px}
.msg.user{background:var(--a);color:#000;align-self:flex-end;border-bottom-right-radius:6px}
.typing{display:flex;gap:5px;padding:12px 16px}
.typing span{width:8px;height:8px;background:var(--ai);border-radius:50%;animation:bounce 1.4s infinite}
.typing span:nth-child(2){animation-delay:0.2s}
.typing span:nth-child(3){animation-delay:0.4s}
@keyframes bounce{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-10px)}}

.chat-input-wrap{display:flex;gap:10px}
.chat-input{flex:1;padding:14px 18px;background:rgba(0,0,0,0.4);border:0.5px solid var(--b);border-radius:16px;color:var(--t1);font-size:14px}
.chat-input:focus{outline:none;border-color:var(--ai)}
.chat-input::placeholder{color:var(--t3)}
.chat-send{width:48px;height:48px;background:linear-gradient(135deg,#5E5CE6,#BF5AF2);border:none;border-radius:14px;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
.chat-send:hover{transform:scale(1.05)}
.chat-send svg{width:20px;height:20px}

/* Data List */
.list-section{background:var(--card);backdrop-filter:blur(20px);border:0.5px solid var(--b);border-radius:24px;padding:20px}
.list-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:12px}
.list-title{font-size:15px;font-weight:600;display:flex;align-items:center;gap:8px}
.list-filters{display:flex;gap:8px;flex-wrap:wrap}
.filter-select{padding:10px 14px;background:rgba(0,0,0,0.3);border:0.5px solid var(--b);border-radius:12px;color:var(--t1);font-size:12px}
.filter-select:focus{outline:none;border-color:var(--a)}
.search-box{position:relative}
.search-box input{padding:10px 14px 10px 38px;background:rgba(0,0,0,0.3);border:0.5px solid var(--b);border-radius:12px;color:var(--t1);font-size:12px;width:160px}
.search-box input:focus{outline:none;border-color:var(--a)}
.search-box svg{position:absolute;left:12px;top:50%;transform:translateY(-50%);width:16px;height:16px;color:var(--t3)}

.data-list{display:flex;flex-direction:column;gap:10px;max-height:400px;overflow-y:auto}
.data-item{background:rgba(0,0,0,0.2);border-radius:16px;padding:16px;transition:all 0.2s}
.data-item:hover{background:rgba(0,0,0,0.3)}
.data-item.dup{border-left:3px solid var(--warn)}
.item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.item-tags{display:flex;gap:6px}
.tag{padding:4px 10px;border-radius:8px;font-size:11px;font-weight:600}
.tag.good{background:rgba(48,209,88,0.15);color:#4ADE80}
.tag.warn{background:rgba(255,214,10,0.15);color:#FBBF24}
.tag.bad{background:rgba(255,69,58,0.15);color:#F87171}
.tag.other{background:rgba(191,90,242,0.15);color:#C084FC}
.del-btn{background:rgba(255,69,58,0.1);border:none;color:#F87171;padding:6px 12px;border-radius:8px;font-size:11px;font-weight:600;cursor:pointer;transition:all 0.2s}
.del-btn:hover{background:rgba(255,69,58,0.2)}
.item-content{font-size:14px;line-height:1.6;margin-bottom:10px}
.item-meta{display:flex;flex-wrap:wrap;gap:16px;font-size:11px;color:var(--t3)}

/* Bottom Nav */
.bnav{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(28,28,30,0.9);backdrop-filter:blur(40px) saturate(180%);-webkit-backdrop-filter:blur(40px) saturate(180%);border:0.5px solid var(--b);border-radius:28px;padding:8px;display:flex;gap:6px;z-index:100;box-shadow:0 10px 40px rgba(0,0,0,0.5)}
.nav-btn{padding:12px 20px;background:transparent;border:none;color:var(--t3);font-size:11px;font-weight:600;cursor:pointer;border-radius:20px;display:flex;align-items:center;gap:8px;transition:all 0.2s}
.nav-btn:hover{color:var(--t2)}
.nav-btn.active{background:rgba(48,209,88,0.15);color:var(--a)}
.nav-btn svg{width:18px;height:18px}
.nav-add{width:56px;height:56px;background:linear-gradient(145deg,#4ADE80,#22C55E);border:none;border-radius:50%;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 20px rgba(34,197,94,0.5);margin:-8px 4px;transition:all 0.2s}
.nav-add:hover{transform:scale(1.1)}
.nav-add:active{transform:scale(0.95)}
.nav-add svg{width:26px;height:26px;stroke-width:2.5}

/* Modal */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);backdrop-filter:blur(10px);z-index:200;align-items:flex-end;justify-content:center}
.modal.show{display:flex}
@media(min-width:600px){.modal{align-items:center}}
.modal-content{background:rgba(28,28,30,0.95);backdrop-filter:blur(40px);border:0.5px solid var(--bl);border-radius:28px 28px 0 0;padding:24px;width:100%;max-width:480px;max-height:90vh;overflow-y:auto;animation:slideUp 0.4s ease}
@media(min-width:600px){.modal-content{border-radius:28px}}
@keyframes slideUp{from{transform:translateY(100%);opacity:0}to{transform:translateY(0);opacity:1}}
.modal-handle{width:36px;height:4px;background:rgba(255,255,255,0.2);border-radius:2px;margin:0 auto 20px}
@media(min-width:600px){.modal-handle{display:none}}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}
.modal-title{font-size:20px;font-weight:700}
.modal-close{width:32px;height:32px;background:var(--glass);border:0.5px solid var(--b);border-radius:50%;color:var(--t3);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px}
.form-group{margin-bottom:14px}
.form-label{display:block;font-size:12px;color:var(--t2);margin-bottom:6px;font-weight:500}
.form-input{width:100%;padding:14px 16px;background:rgba(0,0,0,0.3);border:0.5px solid var(--b);border-radius:14px;color:var(--t1);font-size:14px}
.form-input:focus{outline:none;border-color:var(--a)}
textarea.form-input{resize:none;min-height:100px}
.voice-wrap{position:relative}
.voice-wrap textarea{padding-right:56px}
.voice-btn{position:absolute;right:10px;bottom:10px;width:40px;height:40px;background:var(--glass);border:0.5px solid var(--b);border-radius:12px;color:var(--t3);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
.voice-btn:hover{border-color:var(--a);color:var(--a)}
.voice-btn.rec{background:rgba(255,69,58,0.2);border-color:var(--bad);color:var(--bad);animation:pulse 1s infinite}
.voice-btn svg{width:18px;height:18px}
.voice-status{font-size:11px;color:var(--t3);margin-top:6px;min-height:16px}
.voice-status.rec{color:var(--bad)}
.form-btns{display:flex;gap:12px;margin-top:24px}
.btn{flex:1;padding:16px;border-radius:14px;font-size:14px;font-weight:600;cursor:pointer;border:none;transition:all 0.2s}
.btn-cancel{background:var(--glass);color:var(--t2);border:0.5px solid var(--b)}
.btn-cancel:hover{background:var(--bl)}
.btn-submit{background:linear-gradient(145deg,#4ADE80,#22C55E);color:#000;box-shadow:0 4px 16px rgba(34,197,94,0.4)}
.btn-submit:hover{transform:translateY(-2px)}

.loading{text-align:center;padding:40px;color:var(--t3)}
.loading::after{content:'';display:inline-block;width:20px;height:20px;border:2px solid var(--t3);border-top-color:var(--supa);border-radius:50%;animation:spin 1s linear infinite;margin-left:10px}
.dup-group{background:var(--glass);border:0.5px solid var(--b);border-radius:16px;padding:16px;margin-bottom:16px}
.dup-header{font-size:14px;font-weight:600;color:var(--warn);margin-bottom:12px;padding-bottom:8px;border-bottom:0.5px solid var(--b)}
@keyframes spin{to{transform:rotate(360deg)}}
.empty{text-align:center;padding:40px;color:var(--t3)}
.hidden{display:none!important}
</style>
</head>
<body>
<div class="app">
<header class="hd">
<div class="hdc">
<div class="hdb">
<div class="logo">W!</div>
<div>
<div class="brt">Wan!Voice</div>
<div class="brs" id="connStatus">Supabase æœªæ¥ç¶š</div>
</div>
</div>
<div class="hdr">
<label class="hbtn" title="ã‚¤ãƒ³ãƒãƒ¼ãƒˆ"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg><input type="file" id="csvImport" accept=".csv"></label>
<button class="hbtn" onclick="exportCSV()" title="ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></button>
</div>
</div>
</header>

<main class="mn">
<!-- Supabase Setup -->
<div class="setup-section" id="setupSection">
<div class="setup-header">
<div class="setup-icon">âš¡</div>
<div>
<div class="setup-title">Supabase æ¥ç¶šè¨­å®š</div>
<div class="setup-desc">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®URLã¨APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
</div>
</div>
<div class="setup-form">
<div class="setup-row">
<div>
<label class="setup-label">Project URL</label>
<input type="text" class="setup-input" id="supabaseUrl" placeholder="https://xxxxx.supabase.co">
</div>
<div>
<label class="setup-label">Anon Key</label>
<input type="text" class="setup-input" id="supabaseKey" placeholder="eyJhbGciOiJIUzI1NiIs...">
</div>
</div>
<div class="setup-btns">
<button class="setup-btn primary" onclick="connectSupabase()">ğŸ”Œ æ¥ç¶š</button>
<button class="setup-btn secondary" onclick="useLocalMode()">ğŸ“± ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰ã§ä½¿ã†</button>
</div>
<div class="setup-status" id="setupStatus"></div>
</div>
</div>

<!-- Main Content (hidden until connected) -->
<div id="mainContent" class="hidden">

<!-- Tab: Dashboard -->
<div id="tabDash">
<!-- Stats -->
<div class="stats" id="statsGrid"></div>

<!-- Charts -->
<div class="charts">
<div class="card">
<div class="card-header">
<div class="card-title"><span>ğŸ“Š</span> ä¼šã”ã¨ã®æ¨ç§»</div>
<div class="legend" id="legend"></div>
</div>
<div class="bar-wrap">
<div class="bar-y" id="barY"></div>
<div class="bar-chart" id="barChart"></div>
</div>
</div>
<div class="card">
<div class="card-title"><span>ğŸ“ˆ</span> ã‚«ãƒ†ã‚´ãƒªåˆ†å¸ƒ</div>
<div class="pie-wrap" id="pieChart"></div>
</div>
</div>

<!-- Priority -->
<div class="card" style="margin-bottom:20px">
<div class="card-title"><span>âš¡</span> å„ªå…ˆåº¦åˆ¥</div>
<div class="prio-grid" id="prioChart"></div>
</div>

<!-- AI Chat -->
<div class="ai-section">
<div class="ai-header">
<div class="ai-avatar"><svg viewBox="0 0 100 100" fill="none"><defs><linearGradient id="pg" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#5E5CE6"/><stop offset="100%" style="stop-color:#BF5AF2"/></linearGradient></defs><circle cx="50" cy="50" r="48" fill="url(#pg)"/><ellipse cx="50" cy="62" rx="18" ry="16" fill="#fff"/><ellipse cx="32" cy="40" rx="10" ry="11" fill="#fff"/><ellipse cx="68" cy="40" rx="10" ry="11" fill="#fff"/><ellipse cx="42" cy="28" rx="8" ry="9" fill="#fff"/><ellipse cx="58" cy="28" rx="8" ry="9" fill="#fff"/></svg></div>
<div class="ai-info"><h3>Wan!ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</h3><p>ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯åˆ†æã‚’AIãŒã‚µãƒãƒ¼ãƒˆ</p></div>
<div class="ai-status">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</div>
</div>
<div class="quick-btns">
<button class="qbtn" onclick="askBot('è¦ç´„ã—ã¦')">ğŸ“Š å…¨ä½“è¦ç´„</button>
<button class="qbtn" onclick="askBot('å•é¡Œç‚¹ã¯ï¼Ÿ')">âš ï¸ å•é¡Œç‚¹</button>
<button class="qbtn" onclick="askBot('è‰¯ã‹ã£ãŸç‚¹ã¯ï¼Ÿ')">ğŸ‘ è‰¯ã„ç‚¹</button>
<button class="qbtn" onclick="askBot('å„ªå…ˆåº¦é«˜ã„ã‚‚ã®ã¯ï¼Ÿ')">ğŸ”¥ å„ªå…ˆåº¦é«˜</button>
<button class="qbtn" onclick="askBot('å‚¾å‘ã‚’æ•™ãˆã¦')">ğŸ“ˆ å‚¾å‘</button>
</div>
<div class="chat-box" id="chatBox">
<div class="msg bot">ã“ã‚“ã«ã¡ã¯ï¼Wan!ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ğŸ•<br>Supabaseã¨é€£æºä¸­ï¼ãƒ‡ãƒ¼ã‚¿ã¯ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚</div>
</div>
<div class="chat-input-wrap">
<input type="text" class="chat-input" id="chatInput" placeholder="è³ªå•ã‚’å…¥åŠ›..." onkeypress="if(event.key==='Enter')sendChat()">
<button class="chat-send" onclick="sendChat()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></button>
</div>
</div>
</div>

<!-- Tab: Data List -->
<div id="tabList" class="hidden">
<div class="list-section">
<div class="list-header">
<div class="list-title"><span>ğŸ“‹</span> ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ä¸€è¦§</div>
<div class="list-filters">
<div class="search-box"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" id="searchInput" placeholder="æ¤œç´¢..." oninput="renderList()"></div>
<select class="filter-select" id="filterSession" onchange="renderList()"></select>
<select class="filter-select" id="filterCategory" onchange="renderList()"><option value="all">å…¨ã‚«ãƒ†ã‚´ãƒª</option><option value="è‰¯ã‹ã£ãŸç‚¹">è‰¯ã‹ã£ãŸç‚¹</option><option value="æ”¹å–„ç‚¹">æ”¹å–„ç‚¹</option><option value="ãƒˆãƒ©ãƒ–ãƒ«">ãƒˆãƒ©ãƒ–ãƒ«</option><option value="ãã®ä»–">ãã®ä»–</option></select>
</div>
</div>
<div class="data-list" id="dataList"></div>
</div>
</div>

<!-- Tab: Duplicates -->
<div id="tabDup" class="hidden">
<div class="list-section">
<div class="list-header">
<div class="list-title"><span>ğŸ”„</span> é‡è¤‡ãƒ»é¡ä¼¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</div>
</div>
<div id="dupList"></div>
</div>
</div>

</div>
</main>

<nav class="bnav">
<button class="nav-btn active" onclick="switchTab('Dash')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>ãƒ€ãƒƒã‚·ãƒ¥</button>
<button class="nav-add" onclick="openModal()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button>
<button class="nav-btn" onclick="switchTab('List')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><circle cx="4" cy="6" r="1"/><circle cx="4" cy="12" r="1"/><circle cx="4" cy="18" r="1"/></svg>ä¸€è¦§</button>
<button class="nav-btn" onclick="switchTab('Dup')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>é‡è¤‡</button>
</nav>
</div>

<!-- Modal -->
<div class="modal" id="modal">
<div class="modal-content">
<div class="modal-handle"></div>
<div class="modal-header"><div class="modal-title">æ–°è¦ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</div><button class="modal-close" onclick="closeModal()">Ã—</button></div>
<div class="form-row">
<div class="form-group"><label class="form-label">æ—¥ä»˜</label><input type="date" class="form-input" id="inputDate"></div>
<div class="form-group"><label class="form-label">å›</label><input type="text" class="form-input" id="inputSession" placeholder="ç¬¬â—‹å›"></div>
</div>
<div class="form-row">
<div class="form-group"><label class="form-label">ã‚«ãƒ†ã‚´ãƒª</label><select class="form-input" id="inputCategory"><option value="è‰¯ã‹ã£ãŸç‚¹">è‰¯ã‹ã£ãŸç‚¹</option><option value="æ”¹å–„ç‚¹">æ”¹å–„ç‚¹</option><option value="ãƒˆãƒ©ãƒ–ãƒ«">ãƒˆãƒ©ãƒ–ãƒ«</option><option value="ãã®ä»–">ãã®ä»–</option></select></div>
<div class="form-group"><label class="form-label">å„ªå…ˆåº¦</label><select class="form-input" id="inputPriority"><option value="ä¸­">ä¸­</option><option value="é«˜">é«˜</option><option value="ä½">ä½</option></select></div>
</div>
<div class="form-group"><label class="form-label">ã‚¹ã‚¿ãƒƒãƒ•å</label><input type="text" class="form-input" id="inputStaff" placeholder="åå‰"></div>
<div class="form-group"><label class="form-label">å†…å®¹</label>
<div class="voice-wrap"><textarea class="form-input" id="inputContent" placeholder="ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å†…å®¹..."></textarea><button type="button" class="voice-btn" id="voiceBtn" onclick="toggleVoice()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg></button></div>
<div class="voice-status" id="voiceStatus"></div>
</div>
<div class="form-btns"><button class="btn btn-cancel" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="btn btn-submit" onclick="addEntry()">è¿½åŠ </button></div>
</div>
</div>

<script>
// ===== SUPABASE CONFIG =====
var supabaseUrl = '';
var supabaseKey = '';
var isConnected = false;
var data = [];

var catColors = {è‰¯ã‹ã£ãŸç‚¹:'good',æ”¹å–„ç‚¹:'warn',ãƒˆãƒ©ãƒ–ãƒ«:'bad',ãã®ä»–:'other'};
var catHex = {è‰¯ã‹ã£ãŸç‚¹:'#30D158',æ”¹å–„ç‚¹:'#FFD60A',ãƒˆãƒ©ãƒ–ãƒ«:'#FF453A',ãã®ä»–:'#BF5AF2'};
var prioColors = {é«˜:'#FF453A',ä¸­:'#FFD60A',ä½:'#30D158'};

// ===== SUPABASE CONNECTION =====
async function connectSupabase() {
  var url = document.getElementById('supabaseUrl').value.trim();
  var key = document.getElementById('supabaseKey').value.trim();
  var status = document.getElementById('setupStatus');
  
  if (!url || !key) {
    status.className = 'setup-status error';
    status.textContent = 'âŒ URLã¨APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
    return;
  }
  
  try {
    status.className = 'setup-status';
    status.style.display = 'block';
    status.style.background = 'rgba(255,255,255,0.1)';
    status.style.color = 'var(--t2)';
    status.textContent = 'æ¥ç¶šä¸­...';
    
    supabaseUrl = url;
    supabaseKey = key;
    
    // Use fetch directly for Supabase REST API
    var testRes = await fetch(url + '/rest/v1/feedbacks?limit=1', {
      headers: {
        'apikey': key,
        'Authorization': 'Bearer ' + key
      }
    });
    
    if (!testRes.ok) {
      var errData = await testRes.json();
      throw new Error(errData.message || 'ãƒ†ãƒ¼ãƒ–ãƒ« "feedbacks" ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„');
    }
    
    // Save to localStorage
    localStorage.setItem('wanvoice_supabase_url', url);
    localStorage.setItem('wanvoice_supabase_key', key);
    
    isConnected = true;
    status.className = 'setup-status success';
    status.textContent = 'âœ… æ¥ç¶šæˆåŠŸï¼ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...';
    
    document.getElementById('connStatus').innerHTML = '<span class="connected-badge">Supabase æ¥ç¶šä¸­</span>';
    
    // Load data and show main content
    await loadData();
    
    setTimeout(function() {
      document.getElementById('setupSection').classList.add('hidden');
      document.getElementById('mainContent').classList.remove('hidden');
    }, 1000);
    
  } catch (err) {
    status.className = 'setup-status error';
    status.textContent = 'âŒ æ¥ç¶šå¤±æ•—: ' + (err.message || 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼');
  }
}

function loadScript(src) {
  return new Promise(function(resolve, reject) {
    var script = document.createElement('script');
    script.src = src;
    script.onload = resolve;
    script.onerror = reject;
    document.head.appendChild(script);
  });
}

function useLocalMode() {
  isConnected = false;
  document.getElementById('connStatus').textContent = 'ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰';
  document.getElementById('setupSection').classList.add('hidden');
  document.getElementById('mainContent').classList.remove('hidden');
  
  // Sample data for local mode
  data = [
    {id:1,date:'2024-01-15',session:'ç¬¬1å›',category:'è‰¯ã‹ã£ãŸç‚¹',staff:'ç”°ä¸­',content:'å‚åŠ è€…ã®åå¿œãŒè‰¯ã„',priority:'ä¸­'},
    {id:2,date:'2024-01-15',session:'ç¬¬1å›',category:'æ”¹å–„ç‚¹',staff:'ä½è—¤',content:'è³‡æ–™ã®æ–‡å­—ãŒå°ã•ã„',priority:'é«˜'}
  ];
  renderAll();
  addMsg('ğŸ“± ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ã€‚','bot');
}

async function loadData() {
  if (!isConnected) return;
  
  try {
    var res = await fetch(supabaseUrl + '/rest/v1/feedbacks?order=created_at.desc', {
      headers: {
        'apikey': supabaseKey,
        'Authorization': 'Bearer ' + supabaseKey
      }
    });
    
    if (!res.ok) throw new Error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼');
    
    data = await res.json();
    renderAll();
    addMsg('ğŸ”„ Supabaseã‹ã‚‰ ' + data.length + 'ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼','bot');
  } catch (err) {
    console.error('Load error:', err);
    addMsg('âŒ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + err.message,'bot');
  }
}

// ===== AUTO RECONNECT =====
function autoReconnect() {
  var savedUrl = localStorage.getItem('wanvoice_supabase_url');
  var savedKey = localStorage.getItem('wanvoice_supabase_key');
  
  if (savedUrl && savedKey) {
    document.getElementById('supabaseUrl').value = savedUrl;
    document.getElementById('supabaseKey').value = savedKey;
    connectSupabase();
  }
}

// ===== DATA OPERATIONS =====
async function addEntry() {
  var d = document.getElementById('inputDate').value;
  var s = document.getElementById('inputSession').value;
  var c = document.getElementById('inputCategory').value;
  var p = document.getElementById('inputPriority').value;
  var st = document.getElementById('inputStaff').value;
  var co = document.getElementById('inputContent').value;
  
  if (!d || !s || !st || !co) {
    alert('å…¨ã¦å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  
  var newEntry = {
    date: d,
    session: s,
    category: c,
    priority: p,
    staff: st,
    content: co
  };
  
  if (isConnected) {
    try {
      var res = await fetch(supabaseUrl + '/rest/v1/feedbacks', {
        method: 'POST',
        headers: {
          'apikey': supabaseKey,
          'Authorization': 'Bearer ' + supabaseKey,
          'Content-Type': 'application/json',
          'Prefer': 'return=representation'
        },
        body: JSON.stringify(newEntry)
      });
      
      if (!res.ok) throw new Error('ä¿å­˜ã‚¨ãƒ©ãƒ¼');
      
      var inserted = await res.json();
      data.unshift(inserted[0]);
      addMsg('âœ… Supabaseã«ä¿å­˜ã—ã¾ã—ãŸï¼','bot');
    } catch (err) {
      alert('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + err.message);
      return;
    }
  } else {
    newEntry.id = Date.now();
    data.unshift(newEntry);
    addMsg('âœ… ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã—ã¾ã—ãŸ','bot');
  }
  
  closeModal();
  renderAll();
  document.getElementById('inputSession').value = '';
  document.getElementById('inputStaff').value = '';
  document.getElementById('inputContent').value = '';
}

async function deleteEntry(id) {
  if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  
  if (isConnected) {
    try {
      var res = await fetch(supabaseUrl + '/rest/v1/feedbacks?id=eq.' + id, {
        method: 'DELETE',
        headers: {
          'apikey': supabaseKey,
          'Authorization': 'Bearer ' + supabaseKey
        }
      });
      if (!res.ok) throw new Error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼');
    } catch (err) {
      alert('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + err.message);
      return;
    }
  }
  
  data = data.filter(function(d) { return d.id !== id; });
  renderAll();
}

// ===== VOICE =====
var recognition = null, isRec = false;
function initVoice() {
  var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) { var b = document.getElementById('voiceBtn'); if (b) b.style.display = 'none'; return; }
  recognition = new SR(); recognition.lang = 'ja-JP'; recognition.continuous = false; recognition.interimResults = true;
  recognition.onresult = function(e) { var f = '', t = ''; for (var i = 0; i < e.results.length; i++) { if (e.results[i].isFinal) f += e.results[i][0].transcript; else t += e.results[i][0].transcript; } if (f) document.getElementById('inputContent').value += f; document.getElementById('voiceStatus').textContent = t || (isRec ? 'ğŸ¤ è©±ã—ã¦ãã ã•ã„...' : ''); };
  recognition.onerror = function(e) { if (e.error === 'no-speech' && isRec) setTimeout(startRec, 300); else if (e.error === 'not-allowed') { document.getElementById('voiceStatus').textContent = 'âš ï¸ ãƒã‚¤ã‚¯è¨±å¯ãŒå¿…è¦'; stopVoice(); } };
  recognition.onend = function() { if (isRec) setTimeout(startRec, 300); };
}
function startRec() { if (!isRec || !recognition) return; try { recognition.start(); } catch (e) {} }
function toggleVoice() {
  if (!recognition) { alert('éŸ³å£°å…¥åŠ›ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“'); return; }
  if (isRec) { stopVoice(); return; }
  navigator.mediaDevices.getUserMedia({ audio: true }).then(function() { isRec = true; recognition.start(); document.getElementById('voiceBtn').classList.add('rec'); document.getElementById('voiceStatus').textContent = 'ğŸ”´ éŒ²éŸ³ä¸­...'; document.getElementById('voiceStatus').classList.add('rec'); }).catch(function() { document.getElementById('voiceStatus').textContent = 'âš ï¸ ãƒã‚¤ã‚¯è¨±å¯ãŒå¿…è¦'; });
}
function stopVoice() { isRec = false; try { recognition.abort(); } catch (e) {} document.getElementById('voiceBtn').classList.remove('rec'); document.getElementById('voiceStatus').textContent = ''; document.getElementById('voiceStatus').classList.remove('rec'); }

// ===== ESCAPE =====
function esc(s) { return s ? String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;') : ''; }

// ===== STATS =====
function getStats() { var c = {}, p = {}, s = {}; data.forEach(function(d) { c[d.category] = (c[d.category] || 0) + 1; p[d.priority] = (p[d.priority] || 0) + 1; s[d.session] = s[d.session] || { total: 0 }; s[d.session].total++; s[d.session][d.category] = (s[d.session][d.category] || 0) + 1; }); return { cat: c, prio: p, sess: s }; }
function getSessions() { return [...new Set(data.map(function(d) { return d.session; }))].sort(); }

// ===== SIMILARITY =====
function calcSim(a, b) { var s1 = a.toLowerCase().replace(/[ã€ã€‚ï¼ï¼Ÿ\s]/g, ''), s2 = b.toLowerCase().replace(/[ã€ã€‚ï¼ï¼Ÿ\s]/g, ''); if (s1 === s2) return 1; if (s1.length < 3 || s2.length < 3) return 0; var g1 = new Set(), g2 = new Set(); for (var i = 0; i <= s1.length - 2; i++) g1.add(s1.substring(i, i + 2)); for (var i = 0; i <= s2.length - 2; i++) g2.add(s2.substring(i, i + 2)); var n = 0; g1.forEach(function(x) { if (g2.has(x)) n++; }); var u = g1.size + g2.size - n; return u > 0 ? n / u : 0; }
function findDups() { var dups = [], checked = new Set(); for (var i = 0; i < data.length; i++) { if (checked.has(data[i].id)) continue; var sim = []; for (var j = i + 1; j < data.length; j++) { if (checked.has(data[j].id)) continue; var s = calcSim(data[i].content, data[j].content); if (s > 0.4) { sim.push({ item: data[j], sim: s }); checked.add(data[j].id); } } if (sim.length) { dups.push({ orig: data[i], sim: sim }); checked.add(data[i].id); } } return dups; }
function getDupIds() { var dups = findDups(), ids = new Set(); dups.forEach(function(g) { ids.add(g.orig.id); g.sim.forEach(function(x) { ids.add(x.item.id); }); }); return ids; }

// ===== RENDER =====
function renderStats() {
  var st = getStats(), ss = getSessions(), dups = findDups();
  document.getElementById('statsGrid').innerHTML =
    '<div class="stat"><div class="stat-icon">ğŸ“Š</div><div class="stat-val">' + data.length + '</div><div class="stat-label">ç·ä»¶æ•°</div></div>' +
    '<div class="stat good"><div class="stat-icon">ğŸ‘</div><div class="stat-val">' + (st.cat['è‰¯ã‹ã£ãŸç‚¹'] || 0) + '</div><div class="stat-label">è‰¯ã‹ã£ãŸç‚¹</div></div>' +
    '<div class="stat warn"><div class="stat-icon">âœï¸</div><div class="stat-val">' + (st.cat['æ”¹å–„ç‚¹'] || 0) + '</div><div class="stat-label">æ”¹å–„ç‚¹</div></div>' +
    '<div class="stat bad"><div class="stat-icon">âš ï¸</div><div class="stat-val">' + (st.cat['ãƒˆãƒ©ãƒ–ãƒ«'] || 0) + '</div><div class="stat-label">ãƒˆãƒ©ãƒ–ãƒ«</div></div>' +
    '<div class="stat bad"><div class="stat-icon">ğŸ”¥</div><div class="stat-val">' + (st.prio['é«˜'] || 0) + '</div><div class="stat-label">å„ªå…ˆåº¦é«˜</div></div>' +
    '<div class="stat"><div class="stat-icon">ğŸ”„</div><div class="stat-val">' + dups.length + '</div><div class="stat-label">é‡è¤‡</div></div>';
}

function renderBarChart() {
  var st = getStats(), ss = getSessions();
  var lg = ''; Object.keys(catHex).forEach(function(c) { lg += '<div class="legend-item"><div class="legend-dot" style="background:' + catHex[c] + '"></div>' + c + '</div>'; });
  document.getElementById('legend').innerHTML = lg;
  if (!ss.length) { document.getElementById('barChart').innerHTML = '<div class="empty">ãƒ‡ãƒ¼ã‚¿ãªã—</div>'; return; }
  var max = Math.max.apply(null, ss.map(function(s) { return st.sess[s] ? st.sess[s].total : 0; }));
  document.getElementById('barY').innerHTML = '<span>' + max + '</span><span>' + Math.round(max / 2) + '</span><span>0</span>';
  var html = ''; ss.forEach(function(s) { var d = st.sess[s] || { total: 0 }, t = d.total, h = max ? t / max * 120 : 0; html += '<div class="bar-group"><div class="bar-stack" style="height:' + h + 'px">'; Object.keys(catHex).forEach(function(c) { var n = d[c] || 0, sh = t ? n / t * h : 0; html += '<div class="bar-seg" style="height:' + sh + 'px;background:' + catHex[c] + '"></div>'; }); html += '</div><div class="bar-label">' + s.replace('ç¬¬', '').replace('å›', '') + '</div></div>'; });
  document.getElementById('barChart').innerHTML = html;
}

function renderPieChart() {
  var st = getStats(), t = data.length;
  if (!t) { document.getElementById('pieChart').innerHTML = '<div class="empty">ãƒ‡ãƒ¼ã‚¿ãªã—</div>'; return; }
  var gr = [], cur = 0, lg = '';
  Object.keys(catHex).forEach(function(c) { var n = st.cat[c] || 0, p = n / t * 100; gr.push(catHex[c] + ' ' + cur + '% ' + (cur + p) + '%'); cur += p; lg += '<div class="pie-item"><div class="pie-dot" style="background:' + catHex[c] + '"></div><span>' + c + '</span><span class="pie-pct">' + Math.round(n / t * 100) + '%</span></div>'; });
  document.getElementById('pieChart').innerHTML = '<div class="pie-container"><div class="pie" style="background:conic-gradient(' + gr.join(',') + ')"></div><div class="pie-center"><div class="pie-val">' + t + '</div><div class="pie-label">TOTAL</div></div></div><div class="pie-legend">' + lg + '</div>';
}

function renderPrioChart() {
  var st = getStats(), t = data.length, html = '';
  ['é«˜', 'ä¸­', 'ä½'].forEach(function(p) { var n = st.prio[p] || 0, pct = t ? Math.round(n / t * 100) : 0; html += '<div class="prio-item"><div class="prio-header"><span>å„ªå…ˆåº¦: ' + p + '</span><span>' + n + 'ä»¶</span></div><div class="prio-bar"><div class="prio-fill" style="width:' + pct + '%;background:' + prioColors[p] + '"></div></div></div>'; });
  document.getElementById('prioChart').innerHTML = html;
}

function updateFilters() {
  var ss = getSessions(), sel = document.getElementById('filterSession');
  sel.innerHTML = '<option value="all">å…¨ã¦ã®å›</option>';
  ss.forEach(function(s) { sel.innerHTML += '<option value="' + s + '">' + s + '</option>'; });
}

function renderList() {
  var q = document.getElementById('searchInput').value.toLowerCase(), fs = document.getElementById('filterSession').value, fc = document.getElementById('filterCategory').value, dupIds = getDupIds();
  var filtered = data.filter(function(d) { return (d.content.toLowerCase().indexOf(q) !== -1 || d.staff.toLowerCase().indexOf(q) !== -1) && (fs === 'all' || d.session === fs) && (fc === 'all' || d.category === fc); });
  if (!filtered.length) { document.getElementById('dataList').innerHTML = '<div class="empty">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>'; return; }
  var html = ''; filtered.forEach(function(d) { var isDup = dupIds.has(d.id); html += '<div class="data-item' + (isDup ? ' dup' : '') + '"><div class="item-header"><div class="item-tags"><span class="tag ' + catColors[d.category] + '">' + esc(d.category) + '</span><span class="tag ' + (d.priority === 'é«˜' ? 'bad' : d.priority === 'ä¸­' ? 'warn' : 'good') + '">' + esc(d.priority) + '</span></div><button class="del-btn" onclick="deleteEntry(' + d.id + ')">å‰Šé™¤</button></div><div class="item-content">' + esc(d.content) + '</div><div class="item-meta"><span>ğŸ“… ' + esc(d.date) + '</span><span>ğŸ‘¤ ' + esc(d.staff) + '</span><span>ğŸ·ï¸ ' + esc(d.session) + '</span></div></div>'; });
  document.getElementById('dataList').innerHTML = html;
}

function renderAll() { renderStats(); renderBarChart(); renderPieChart(); renderPrioChart(); updateFilters(); renderList(); }

// ===== AI CHAT =====
function sendChat() { var input = document.getElementById('chatInput'), msg = input.value.trim(); if (!msg) return; addMsg(msg, 'user'); input.value = ''; showTyping(); setTimeout(function() { hideTyping(); addMsg(generateAI(msg), 'bot'); }, 800); }
function askBot(q) { document.getElementById('chatInput').value = q; sendChat(); }
function addMsg(txt, type) { var box = document.getElementById('chatBox'), div = document.createElement('div'); div.className = 'msg ' + type; div.innerHTML = txt; box.appendChild(div); box.scrollTop = box.scrollHeight; }
function showTyping() { var box = document.getElementById('chatBox'), div = document.createElement('div'); div.className = 'msg bot typing-ind'; div.innerHTML = '<div class="typing"><span></span><span></span><span></span></div>'; box.appendChild(div); box.scrollTop = box.scrollHeight; }
function hideTyping() { var t = document.querySelector('.typing-ind'); if (t) t.remove(); }

function generateAI(q) {
  var ql = q.toLowerCase();
  if (ql.includes('è¦ç´„') || ql.includes('ã¾ã¨ã‚')) { var st = getStats(), ss = getSessions(); return 'ğŸ“Š <b>ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¦ç´„</b><br><br>å…¨<b>' + data.length + 'ä»¶</b>ï¼ˆ' + ss.length + 'å›åˆ†ï¼‰<br><br>ğŸ‘ è‰¯ã‹ã£ãŸç‚¹: ' + (st.cat['è‰¯ã‹ã£ãŸç‚¹'] || 0) + 'ä»¶<br>âœï¸ æ”¹å–„ç‚¹: ' + (st.cat['æ”¹å–„ç‚¹'] || 0) + 'ä»¶<br>âš ï¸ ãƒˆãƒ©ãƒ–ãƒ«: ' + (st.cat['ãƒˆãƒ©ãƒ–ãƒ«'] || 0) + 'ä»¶<br>ğŸ”¥ å„ªå…ˆåº¦é«˜: ' + (st.prio['é«˜'] || 0) + 'ä»¶' + (isConnected ? '<br><br>â˜ï¸ Supabaseã«ä¿å­˜ä¸­' : ''); }
  if (ql.includes('å•é¡Œ') || ql.includes('ãƒˆãƒ©ãƒ–ãƒ«') || ql.includes('èª²é¡Œ')) { var probs = data.filter(function(d) { return d.category === 'ãƒˆãƒ©ãƒ–ãƒ«' || d.category === 'æ”¹å–„ç‚¹'; }); if (!probs.length) return 'âœ… å•é¡Œç‚¹ã®å ±å‘Šã¯ã‚ã‚Šã¾ã›ã‚“'; var r = 'âš ï¸ <b>å•é¡Œç‚¹ï¼ˆ' + probs.length + 'ä»¶ï¼‰</b><br><br>'; probs.slice(0, 4).forEach(function(p) { r += 'â€¢ ' + esc(p.content) + '<br><small style="color:var(--t3)">' + p.session + '/' + p.staff + '</small><br><br>'; }); return r; }
  if (ql.includes('è‰¯ã‹ã£ãŸ') || ql.includes('è‰¯ã„ç‚¹')) { var goods = data.filter(function(d) { return d.category === 'è‰¯ã‹ã£ãŸç‚¹'; }); if (!goods.length) return 'è‰¯ã‹ã£ãŸç‚¹ã®å ±å‘Šã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“'; var r = 'ğŸ‘ <b>è‰¯ã‹ã£ãŸç‚¹ï¼ˆ' + goods.length + 'ä»¶ï¼‰</b><br><br>'; goods.slice(0, 4).forEach(function(g) { r += 'â€¢ ' + esc(g.content) + '<br><small style="color:var(--t3)">' + g.session + '/' + g.staff + '</small><br><br>'; }); return r; }
  if (ql.includes('å„ªå…ˆ') || ql.includes('ç·Šæ€¥')) { var high = data.filter(function(d) { return d.priority === 'é«˜'; }); if (!high.length) return 'âœ… å„ªå…ˆåº¦é«˜ã®é …ç›®ã¯ã‚ã‚Šã¾ã›ã‚“'; var r = 'ğŸ”¥ <b>å„ªå…ˆåº¦é«˜ï¼ˆ' + high.length + 'ä»¶ï¼‰</b><br><br>'; high.forEach(function(h) { r += 'â€¢ ' + esc(h.content) + '<br><small style="color:var(--t3)">' + h.category + '/' + h.session + '</small><br><br>'; }); return r; }
  if (ql.includes('å‚¾å‘') || ql.includes('åˆ†æ')) { var ss = getSessions(), st = getStats(), r = 'ğŸ“ˆ <b>å‚¾å‘åˆ†æ</b><br><br>'; ss.forEach(function(s) { var d = st.sess[s] || {}, g = d['è‰¯ã‹ã£ãŸç‚¹'] || 0, b = (d['æ”¹å–„ç‚¹'] || 0) + (d['ãƒˆãƒ©ãƒ–ãƒ«'] || 0); r += '<b>' + s + '</b>: ğŸ‘' + g + ' / ğŸ“' + b + '<br>'; }); return r; }
  var sm = ql.match(/ç¬¬(\d+)å›/); if (sm) { var ts = 'ç¬¬' + sm[1] + 'å›', sd = data.filter(function(d) { return d.session === ts; }); if (!sd.length) return ts + 'ã®ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“'; var r = 'ğŸ“‹ <b>' + ts + 'ï¼ˆ' + sd.length + 'ä»¶ï¼‰</b><br><br>'; sd.forEach(function(d) { r += 'â€¢ [' + d.category + '] ' + esc(d.content) + '<br>'; }); return r; }
  return 'ğŸ¤” ã™ã¿ã¾ã›ã‚“ã€ã‚ˆãã‚ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚<br><br>ã“ã‚“ãªè³ªå•ãŒã§ãã¾ã™ï¼š<br>â€¢ è¦ç´„ã—ã¦<br>â€¢ å•é¡Œç‚¹ã¯ï¼Ÿ<br>â€¢ è‰¯ã‹ã£ãŸç‚¹<br>â€¢ å„ªå…ˆåº¦é«˜ã„ã‚‚ã®<br>â€¢ ç¬¬1å›ã®å†…å®¹';
}

// ===== MODAL =====
function openModal() { document.getElementById('modal').classList.add('show'); document.getElementById('inputDate').value = new Date().toISOString().split('T')[0]; }
function closeModal() { stopVoice(); document.getElementById('modal').classList.remove('show'); }

// ===== NAVIGATION =====
function switchTab(tab) {
  // Hide all tabs
  document.getElementById('tabDash').classList.add('hidden');
  document.getElementById('tabList').classList.add('hidden');
  document.getElementById('tabDup').classList.add('hidden');
  
  // Remove active from all nav buttons
  document.querySelectorAll('.nav-btn').forEach(function(b) { b.classList.remove('active'); });
  
  // Show selected tab and activate button
  if (tab === 'Dash') {
    document.getElementById('tabDash').classList.remove('hidden');
    document.querySelectorAll('.nav-btn')[0].classList.add('active');
  } else if (tab === 'List') {
    document.getElementById('tabList').classList.remove('hidden');
    document.querySelectorAll('.nav-btn')[1].classList.add('active');
    renderList();
  } else if (tab === 'Dup') {
    document.getElementById('tabDup').classList.remove('hidden');
    document.querySelectorAll('.nav-btn')[2].classList.add('active');
    renderDuplicates();
  }
  
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ===== DUPLICATES =====
function renderDuplicates() {
  var dups = findDups();
  var container = document.getElementById('dupList');
  
  if (!dups.length) {
    container.innerHTML = '<div class="empty">é‡è¤‡ã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }
  
  var html = '';
  dups.forEach(function(g, i) {
    html += '<div class="dup-group">';
    html += '<div class="dup-header">ğŸ”„ ã‚°ãƒ«ãƒ¼ãƒ— ' + (i + 1) + 'ï¼ˆ' + (g.sim.length + 1) + 'ä»¶ã®é¡ä¼¼ï¼‰</div>';
    
    // Original
    html += '<div class="data-item">';
    html += '<div class="item-header"><div class="item-tags"><span class="tag ' + catColors[g.orig.category] + '">' + esc(g.orig.category) + '</span></div></div>';
    html += '<div class="item-content">' + esc(g.orig.content) + '</div>';
    html += '<div class="item-meta"><span>ğŸ‘¤ ' + esc(g.orig.staff) + '</span><span>ğŸ·ï¸ ' + esc(g.orig.session) + '</span></div>';
    html += '</div>';
    
    // Similar items
    g.sim.forEach(function(s) {
      html += '<div class="data-item dup">';
      html += '<div class="item-header"><div class="item-tags"><span class="tag ' + catColors[s.item.category] + '">' + esc(s.item.category) + '</span><span class="tag warn">' + Math.round(s.sim * 100) + '% é¡ä¼¼</span></div></div>';
      html += '<div class="item-content">' + esc(s.item.content) + '</div>';
      html += '<div class="item-meta"><span>ğŸ‘¤ ' + esc(s.item.staff) + '</span><span>ğŸ·ï¸ ' + esc(s.item.session) + '</span></div>';
      html += '</div>';
    });
    
    html += '</div>';
  });
  
  container.innerHTML = html;
}

// ===== CSV =====
function exportCSV() {
  var h = ['date', 'session', 'category', 'staff', 'content', 'priority'], csv = h.join(',') + '\n';
  data.forEach(function(d) { csv += h.map(function(k) { return '"' + (d[k] || '') + '"'; }).join(',') + '\n'; });
  var a = document.createElement('a'); a.href = URL.createObjectURL(new Blob(['\ufeff' + csv], { type: 'text/csv' })); a.download = 'wanvoice_' + new Date().toISOString().split('T')[0] + '.csv'; a.click();
}

document.getElementById('csvImport').addEventListener('change', async function(e) {
  var f = e.target.files[0]; if (!f) return;
  var r = new FileReader(); r.onload = async function(ev) {
    try {
      var lines = ev.target.result.split('\n'), hd = lines[0].split(',').map(function(h) { return h.trim().replace(/"/g, ''); }), cnt = 0;
      var newEntries = [];
      for (var i = 1; i < lines.length; i++) {
        var ln = lines[i].trim(); if (!ln) continue;
        var vals = ln.split(',').map(function(v) { return v.trim().replace(/"/g, ''); });
        newEntries.push({
          date: vals[hd.indexOf('date')] || vals[0] || '',
          session: vals[hd.indexOf('session')] || vals[1] || '',
          category: vals[hd.indexOf('category')] || vals[2] || 'è‰¯ã‹ã£ãŸç‚¹',
          staff: vals[hd.indexOf('staff')] || vals[3] || '',
          content: vals[hd.indexOf('content')] || vals[4] || '',
          priority: vals[hd.indexOf('priority')] || vals[5] || 'ä¸­'
        });
        cnt++;
      }
      
      if (isConnected && newEntries.length) {
        var res = await fetch(supabaseUrl + '/rest/v1/feedbacks', {
          method: 'POST',
          headers: {
            'apikey': supabaseKey,
            'Authorization': 'Bearer ' + supabaseKey,
            'Content-Type': 'application/json',
            'Prefer': 'return=representation'
          },
          body: JSON.stringify(newEntries)
        });
        if (!res.ok) throw new Error('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼');
        var inserted = await res.json();
        data = inserted.concat(data);
      } else {
        newEntries.forEach(function(e, i) { e.id = Date.now() + i; data.unshift(e); });
      }
      
      renderAll();
      addMsg('ğŸ“¥ ' + cnt + 'ä»¶ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼', 'bot');
    } catch (err) { alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—: ' + err.message); }
    e.target.value = '';
  }; r.readAsText(f);
});

document.getElementById('modal').addEventListener('click', function(e) { if (e.target === this) closeModal(); });

// ===== INIT =====
initVoice();
autoReconnect();
</script>
</body>
</html>
